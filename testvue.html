<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/http-vue-loader/src/httpVueLoader.min.js"></script>
        <script src="https://unpkg.com/@johmun/vue-tags-input/dist/vue-tags-input.js"></script>
    </head>
    <body>
        <div id="app">
            <a href="#upload">上传录像</a>
            <vue-tags-input
                placeholder="过来吧录像类型"
                add-only-from-autocomplete="true"
                v-model="filterTag"
                :tags="complexFilterTags"
                :autocomplete-items="availableComplexFilterTags"
                @tags-changed="newTags => { complexFilterTags = newTags; loadReplays(); }"
            >
            </vue-tags-input>
            <br/>
            排序方式：
            <select v-model="selectedOrder">
                <option v-for="option in orderOptions" v-bind:value="option.value">
                    {{ option.text }}
                </option>
            </select>
            <div v-for="replay in replayList" :key="replay.id">
                <replay-item :replay-id="replay.id" 
                    faction-icon-format="/replays/ra3images/v1/factions/*.png"
                    map-image-format="/replays/ra3images/v1/maps/*_art.png"
                    default-map-image-path="/replays/ra3images/v1/factions/7.png"
                >
                </replay-item>
            </div>
            <div id="upload">
                <vue-tags-input
                    placeholder="上传录像类型"
                    v-model="UploadTag"
                    :tags="complexUploadTags"
                    :autocomplete-items="availableComplexUploadTags"
                    @tags-changed="newTags => complexUploadTags = newTags"
                >
                <input type="text" v-model="title" placeholder="title" />
                <input type="text" v-model="description" placeholder="description"/>
                <label for="upload">选择录像文件：</label>
                <input type="file" id="upload" ref="upload" />
                <button @click="uploadReplay">上传录像</button>
                <p>{{ uploadStatus }}</p>
            </div>
            
        </div>
        <script>
            const app = new Vue({
                el: '#app',
                components: {
                    'replay-item': httpVueLoader('replay-compact.vue'),
                },
                data() {
                    return {
                        title: '',
                        description: '',
                        uploadStatus: '',
                        replayList: [],
                        filterTag: '',
                        orderTag: '',
                        uploadTag: '',
                        complexFilterTags: [],
                        complexOrderTags: [],
                        complexUploadTags: [],
                        availableComplexFilterTags: [],
                        selectedOrder: null,
                        orderOptions: [
                            { text: '上传时间降序', value: { column: 'id', order: 'DESC' } },
                            { text: '上传时间升序', value: { column: 'id', order: 'ASC' } },
                            { text: '录像日期降序', value: { column: 'timeStamp', order: 'DESC' } },
                            { text: '录像日期升序', value: { column: 'timeStamp', order: 'ASC' } },
                            { text: '录像时长降序', value: { column: 'totalFrames', order: 'DESC' } },
                            { text: '录像时长升序', value: { column: 'totalFrames', order: 'ASC' } },
                            { text: '文件大小降序', value: { column: 'fileSize', order: 'DESC' } },
                            { text: '文件大小升序', value: { column: 'fileSize', order: 'ASC' } },
                        ]
                    };
                },
                mounted() {
                    setInterval(this.loadReplays, 10000);
                    this.loadReplays();
                },
                methods: {
                    processComplexTags(complexTags) {
                        return complexTags
                        .filter(tag => tag.tiClasses.includes('ti-valid'))
                        .map(tag => tag.text);
                    },
                    loadReplays() {
                        const filters = JSON.stringify(this.processComplexTags(this.complexFilterTags));
                        const orders = JSON.stringify([this.selectedOrder])
                        fetch('/replays/replay.php?do=getReplayList&tags=' + filters + '&orders=' + orders)
                        .then(response => response.json())
                        .then(json => { this.replayList = json.replays || []; });

                        fetch('/replays/replay.php?do=getTagList')
                        .then(response => response.json())
                        .then(json => {
                            this.availableComplexFilterTags = json.tags.map(x => { return { text: x }; });
                        })
                    },
                    uploadReplay() {
                        let files = this.$refs.upload.files;
                        this.uploadStatus = 'reading...';
                        if(files.length == 0) {
                            this.uploadStatus = 'nothing selected';
                            return;
                        }
                        let file = files.item(0);
                        let reader = new FileReader();
                        let self = this;
                        reader.onloadend = () => {
                            self.uploadStatus = 'preparing...';
                            let binaryString = '';
                            let bytes = new Uint8Array(reader.result);
                            let length = bytes.byteLength;
                            for (var i = 0; i < length; ++i) {
                                binaryString += String.fromCharCode(bytes[i]);
                            }
                            let base64 = btoa(binaryString);
                            self.uploadStatus = 'loading...';
                            fetch('/replays/replay.php?do=uploadReplay', {
                                method: 'post',
                                body: JSON.stringify({
                                    fileName: file.name,
                                    data: base64,
                                    title: this.title,
                                    description: this.description,
                                    tags: this.processComplexTags(this.complexUploadTags)
                                }),
                                headers: {
                                    'content-type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(json => { 
                                self.uploadStatus = 'result: ' + JSON.stringify(json);  
                                self.loadReplays();
                            });
                        };
                        reader.readAsArrayBuffer(file);
                    },
                },
                computed: {
                    
                },
            });
        </script>
    </body>
        
</html>
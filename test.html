<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="replay.js"></script>
    </head>
    <body>
        <div id="app">
            <input type="file" ref="myFiles" @change="onFileChange()" />
            <p>{{ parsed }}</p>
            <label for="upload">Upload:</label>
            <input type="file" id="upload" ref="upload" />
            <button @click="uploadReplay">Upload</button>
            <p>{{ uploadStatus }}</p>
            <ul>
                <li v-for="replay in replayList">
                    <replay :replayID="replay.id" :key="replay.id"></replay>
                </li>
            </ul>
        </div>
        <script>
            let app = new Vue({
                el: '#app',
                data: {
                    parsed: '',
                    uploadStatus: '',
                    replayList: [],
                },
                mounted: function() {
                    setInterval(this.loadReplays, 10000);
                    this.loadReplays();
                },
                methods: {
                    loadReplays: function() {
                        let self = this;
                        fetch('replay.php?do=getReplayList')
                        .then(response => response.json())
                        .then(json => { self.replayList = json.replays || []; });
                    },
                    onFileChange: function() {
                        this.parsed = 'reading...';
                        let files = this.$refs.myFiles.files;
                        if(files.length == 0) {
                            this.parsed = 'nothing selected';
                            return;
                        }
                        let file = files.item(0);
                        let reader = new FileReader();
                        let self = this;
                        reader.onloadend = () => {
                            self.parsed = 'preparing...';
                            let binaryString = '';
                            let bytes = new Uint8Array(reader.result);
                            let length = bytes.byteLength;
                            for (var i = 0; i < length; ++i) {
                                binaryString +=  String.fromCharCode(bytes[i]);
                            }
                            let base64 = btoa(binaryString);
                            self.parsed = 'loading...';
                            fetch('replay.php?do=test', {
                                method: 'post',
                                body: JSON.stringify({
                                    data: base64
                                }),
                                headers: {
                                    'content-type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(json => self.onResponse(json));
                        };
                        reader.readAsArrayBuffer(file);                        
                    },
                    onResponse: function(json) {
                        this.parsed = json;
                    },
                    uploadReplay: function() {
                        let files = this.$refs.upload.files;
                        this.uploadStatus = 'reading...';
                        if(files.length == 0) {
                            this.uploadStatus = 'nothing selected';
                            return;
                        }
                        let file = files.item(0);
                        let reader = new FileReader();
                        let self = this;
                        reader.onloadend = () => {
                            self.uploadStatus = 'preparing...';
                            let binaryString = '';
                            let bytes = new Uint8Array(reader.result);
                            let length = bytes.byteLength;
                            for (var i = 0; i < length; ++i) {
                                binaryString += String.fromCharCode(bytes[i]);
                            }
                            let base64 = btoa(binaryString);
                            self.uploadStatus = 'loading...';
                            fetch('replay.php?do=uploadReplay', {
                                method: 'post',
                                body: JSON.stringify({
                                    fileName: file.name,
                                    data: base64
                                }),
                                headers: {
                                    'content-type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(json => { 
                                self.uploadStatus = 'result: ' + json;  
                                self.loadReplays();
                            });
                        };
                        reader.readAsArrayBuffer(file);
                    },
                },
            })
        </script>
    </body>
</html>